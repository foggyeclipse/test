<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Форма ввода данных</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .day {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
        }
        .activity {
            margin-left: 20px;
            padding: 5px;
        }
        /* .activity.good {
            color: green;
        }
        .activity.bad {
            color: red;
        } */
    </style>
    <style>
        .form-group {
            margin-bottom: 15px;
        }
        .form-control {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        body {
            padding-top: 20px;
        }
        .container {
            max-width: 800px;
        }
        .form-control {
            margin-bottom: 10px;
        }
        .hidden-input {
            display: none;
        }
        .form-group {
            margin-bottom: 15px;
        }
        /* Стиль для оверлея */
        .overlay {
            display: none; /* Скрыт по умолчанию */
            position: fixed; /* Фиксированное позиционирование для покрытия всего экрана */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8); /* Белый полупрозрачный фон */
            z-index: 1000; /* Над всеми другими элементами */
        }
        .loader {
            display: none;
            position: fixed; /* Фиксированное позиционирование для центрирования */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Центрирование по горизонтали и вертикали */
            z-index: 1001; /* Над оверлеем */
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            border: .25em solid #007bff; 
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }

        /* @keyframes spinner-border {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        } */
        /* .loader {
            display: none;
            position: absolute;
            top: 154%;
            left: 56%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        .loader .spinner-border {
            width: 3rem;
            height: 3rem;
        } */
        #map {
            height: 500px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center">Форма ввода данных</h2>
        <form id="dataForm" method="post" action="/radius">
            <!-- Поля формы -->
            <div class="form-group">
                <label for="date_of_loss">Дата потери:</label>
                <input type="text" id="date_of_loss" name="date_of_loss" class="form-control"
                    placeholder="Введите дату потери" required>
                <label for="time_of_loss">Время потери:</label>
                <input type="time" id="time_of_loss" name="time_of_loss" class="form-control" value="12:00"
                    placeholder="Введите время потери">
            </div>
    
            <div class="form-group">
                <label for="date_of_finding">Текущая дата:</label>
                <input type="text" id="date_of_finding" name="date_of_finding" class="form-control readonly-field"
                    placeholder="Введите дату нахождения" required>
                <label for="time_of_finding">Текущее время:</label>
                <input type="time" id="time_of_finding" name="time_of_finding" class="form-control"
                    placeholder="Введите текущее время">
            </div>
            <div class="form-group">
                <label for="age">Возраст:</label>
                <input type="number" id="age" name="age" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="gender">Пол:</label>
                <select id="gender" name="gender" class="form-control" required>
                    <option value="unknown" selected>Неизвестно</option>
                    <option value="male">Мужской</option>
                    <option value="female">Женский</option>
                </select>
            </div>
            <div class="form-group">
                <label for="physical_condition">Физическое состояние:</label>
                <select id="physical_condition" name="physical_condition" class="form-control" required>
                    <option value="unknown" selected>Неизвестно</option>
                    <option value="healthy">Здоров</option>
                    <option value="chronic_disease">Хронические заболевания</option>
                    <option value="injury">Травма</option>
                    <option value="health_deterioration">Ухудшение здоровья</option>
                </select>
            </div>
            <div class="form-group">
                <label for="mental_condition">Психическое состояние:</label>
                <select id="mental_condition" name="mental_condition" class="form-control" required>
                    <option value="unknown" selected>Неизвестно</option>
                    <option value="stable">Устойчив</option>
                    <option value="unstable">Неустойчив</option>
                </select>
            </div>
            <div class="form-group">
                <label for="psr_lat">Широта центра ПСР:</label>
                <input type="text" id="psr_lat" name="psr_lat" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="psr_lon">Долгота центра ПСР:</label>
                <input type="text" id="psr_lon" name="psr_lon" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="finding_lat">Широта нахождения:</label>
                <input type="text" id="finding_lat" name="finding_lat" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="finding_lon">Долгота нахождения:</label>
                <input type="text" id="finding_lon" name="finding_lon" class="form-control" required>
            </div>

            <div class="form-group">
                <button type="button" class="btn btn-info" id="toggleAdditionalFields">Дополнительные данные</button>
            </div>

            <div id="additional_fields" class="hidden-input">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="tab1-tab" data-toggle="tab" href="#tab1" role="tab"
                            aria-controls="tab1" aria-selected="true">Данные о потерявшемся</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="tab2-tab" data-toggle="tab" href="#tab2" role="tab" aria-controls="tab2"
                            aria-selected="false">Данные о местности</a>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="tab1" role="tabpanel" aria-labelledby="tab1-tab">
                        <div class="form-group">
                            <label for="experience">Опыт нахождения в дикой природе:</label>
                            <select id="experience" name="experience" class="form-control">
                                <option value="unknown" selected>Неизвестно</option>
                                <option value="low">Низкий</option>
                                <option value="medium">Средний</option>
                                <option value="high">Высокий</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="local_knowledge">Знание местности:</label>
                            <select id="local_knowledge" name="local_knowledge" class="form-control">
                                <option value="unknown" selected>Неизвестно</option>
                                <option value="yes">Да</option>
                                <option value="no">Нет</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="phone">Наличие телефона:</label>
                            <select id="phone" name="phone" class="form-control">
                                <option value="unknown" selected>Неизвестно</option>
                                <option value="yes">Да</option>
                                <option value="no">Нет</option>
                            </select>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tab2" role="tabpanel" aria-labelledby="tab2-tab">
                        <div class="form-group">
                            <label for="terrain_passability">Проходимость местности:</label>
                            <input type="number" id="terrain_passability" name="terrain_passability"
                                class="form-control" step="0.01" min="0" max="1">
                        </div>
                        <div class="form-group">
                            <label for="path_curvature">Кривизна местности:</label>
                            <input type="number" id="path_curvature" name="path_curvature" class="form-control"
                                step="0.01" min="0" max="1">
                        </div>
                        <div class="form-group">
                            <label for="slope_angle">Угол наклона местности:</label>
                            <input type="number" id="slope_angle" name="slope_angle" class="form-control" step="0.01"
                                min="0" max="1">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group text-center">
                <button type="submit" class="btn btn-primary">Отправить</button>
            </div>

            <!-- Оверлей для полупрозрачного фона -->
            <div class="overlay" id="overlay"></div>
            <!-- Индикатор загрузки -->
            <div class="loader" id="loader">
                <div class="spinner-border"></div>
            </div>
        </form>

        <!-- Место для карты -->
        <div id="map"></div>

        <!-- Блок для вывода результата -->
        <div id="result"></div>

        <div id="report"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script>
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Месяцы начинаются с 0
            const year = date.getFullYear();
            return `${day}.${month}.${year}`; // Формат даты YYYY-MM-DD
        }

        // Получаем текущую дату
        const currentDate = new Date();
        // Форматируем дату
        const formattedDate = formatDate(currentDate);
        // Устанавливаем значение поля
        document.getElementById('date_of_finding').value = formattedDate;
        console.log($('#psr_lat').val())
        function parseCoordinate(coord) {
            return parseFloat(coord.replace(',', '.'));
        }

        // Устанавливаем текущее системное время в поле time_of_finding
        const hours = String(currentDate.getHours()).padStart(2, '0');
        const minutes = String(currentDate.getMinutes()).padStart(2, '0');
        const currentTime = `${hours}:${minutes}`;
        document.getElementById('time_of_finding').value = currentTime;

        $(document).ready(function () {
            let mapCreated = false; // Переменная для отслеживания создания карты
            let map; // Глобальная переменная для карты

            $('#toggleAdditionalFields').click(function () {
                $('#additional_fields').toggleClass('hidden-input');
                if (!$('#additional_fields').hasClass('hidden-input')) {
                    $('#myTab .nav-link').first().tab('show'); // Показать первую вкладку по умолчанию
                }
            });

            // Валидация коэффициентов на вкладке 2
            $('#tab2 input[type="number"]').on('input', function () {
                var value = parseFloat($(this).val());
                if (value < 0 || value > 1) {
                    alert('Коэффициент должен быть в пределах от 0 до 1');
                    $(this).val('');
                }
            });

            $('#dataForm').on('submit', function (e) {
                e.preventDefault(); // Отключить стандартное поведение отправки формы
                
                $('#overlay').show(); // Показать полупрозрачный фон
                $('#loader').show(); // Показать индикатор загрузки

                // Собрать данные формы, учитывая необязательные поля
                var data = {
                    date_of_loss: $('#date_of_loss').val(),
                    time_of_loss: $('#time_of_loss').val(),
                    date_of_finding: $('#date_of_finding').val(),
                    time_of_finding: $('#time_of_finding').val(),
                    age: $('#age').val(),
                    gender: $('#gender').val(),
                    physical_condition: $('#physical_condition').val(),
                    mental_condition: $('#mental_condition').val(),
                    experience: $('#experience').val() || null,
                    local_knowledge: $('#local_knowledge').val() || null,
                    phone: $('#phone').val() || null,
                    terrain_passability: $('#terrain_passability').val() || null,
                    path_curvature: $('#path_curvature').val() || null,
                    slope_angle: $('#slope_angle').val() || null,
                    coords_psr: {
                        latitude: parseCoordinate($('#psr_lat').val()),
                        longitude: parseCoordinate($('#psr_lon').val())
                    },
                    coords_finding: {
                        latitude: parseCoordinate($('#finding_lat').val()),
                        longitude: parseCoordinate($('#finding_lon').val())
                    }
                };

                $.ajax({
                    url: '/radius',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (response) {
                        if (response && response.coords_psr) {
                            if (map) {
                                map.remove(); // Удалить предыдущую карту, если она существует
                                mapCreated = false; // Сбрасываем флаг, чтобы можно было создать новую карту
                            }
                            if (!mapCreated) {
                                map = L.map('map').setView([response.coords_psr.latitude, response.coords_psr.longitude], 13);
                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                    maxZoom: 18,
                                    attribution: 'Map data © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                                }).addTo(map);
                                mapCreated = true;
                            }
                            <!-- var maskCoords =[[59.9227, 34.27895], [59.922, 34.278850000000006], [59.922, 34.27695000000001], [59.921299999999995, 34.27685], [59.921299999999995, 34.27615], [59.92059999999999, 34.276050000000005], [59.92059999999999, 34.27555], [59.9199, 34.275450000000006], [59.9199, 34.27505], [59.9192, 34.274950000000004], [59.9192, 34.274550000000005], [59.918499999999995, 34.27445], [59.918499999999995, 34.274150000000006], [59.9178, 34.27405], [59.9178, 34.27375000000001], [59.9171, 34.27365], [59.9171, 34.27335], [59.916399999999996, 34.273250000000004], [59.916399999999996, 34.273050000000005], [59.915699999999994, 34.27295], [59.915699999999994, 34.27275], [59.915, 34.272650000000006], [59.915, 34.272450000000006], [59.9143, 34.27235], [59.9143, 34.27215], [59.913599999999995, 34.27205], [59.913599999999995, 34.27185], [59.91289999999999, 34.271750000000004], [59.91289999999999, 34.27165], [59.9122, 34.271550000000005], [59.9122, 34.271350000000005], [59.9115, 34.27125], [59.9115, 34.271150000000006], [59.910799999999995, 34.27105], [59.910799999999995, 34.270950000000006], [59.9101, 34.27085], [59.9101, 34.27065], [59.9094, 34.27055], [59.9094, 34.270450000000004], [59.908699999999996, 34.27035], [59.908699999999996, 34.270250000000004], [59.907999999999994, 34.27015], [59.907999999999994, 34.270050000000005], [59.9073, 34.26995], [59.9073, 34.269850000000005], [59.9066, 34.26975], [59.9066, 34.269650000000006], [59.905899999999995, 34.26955], [59.905899999999995, 34.269450000000006], [59.905199999999994, 34.26935], [59.905199999999994, 34.26925000000001], [59.9038, 34.26905], [59.9038, 34.268950000000004], [59.903099999999995, 34.26885], [59.903099999999995, 34.268750000000004], [59.90239999999999, 34.26865], [59.90239999999999, 34.268550000000005], [59.900999999999996, 34.268350000000005], [59.900999999999996, 34.26825], [59.8996, 34.26805], [59.8996, 34.267950000000006], [59.898199999999996, 34.26775000000001], [59.898199999999996, 34.26765], [59.8968, 34.267450000000004], [59.8968, 34.26735], [59.89469999999999, 34.267050000000005], [59.89469999999999, 34.26695], [59.892599999999995, 34.266650000000006], [59.892599999999995, 34.26655], [59.889799999999994, 34.26615], [59.889799999999994, 34.26605000000001], [59.8856, 34.26545], [59.8856, 34.265350000000005], [59.877199999999995, 34.26415], [59.87649999999999, 34.26415], [59.872299999999996, 34.26355], [59.871599999999994, 34.26355], [59.86879999999999, 34.26315], [59.8681, 34.26315], [59.866, 34.26285], [59.8653, 34.26285], [59.8632, 34.262550000000005], [59.8625, 34.262550000000005], [59.86109999999999, 34.262350000000005], [59.8604, 34.262350000000005], [59.858999999999995, 34.262150000000005], [59.8576, 34.262150000000005], [59.856899999999996, 34.26225], [59.856199999999994, 34.26225], [59.8527, 34.262750000000004], [59.8527, 34.26285], [59.845, 34.26395], [59.845, 34.264050000000005], [59.837999999999994, 34.26505], [59.837999999999994, 34.265150000000006], [59.830299999999994, 34.26625000000001], [59.830299999999994, 34.26635], [59.828199999999995, 34.266650000000006], [59.823299999999996, 34.266650000000006], [59.822599999999994, 34.26655], [59.8219, 34.26655], [59.8212, 34.266450000000006], [59.819799999999994, 34.266450000000006], [59.8191, 34.26635], [59.8184, 34.26635], [59.817699999999995, 34.26625000000001], [59.8163, 34.26625000000001], [59.815599999999996, 34.26615], [59.814899999999994, 34.26615], [59.8142, 34.26605000000001], [59.812799999999996, 34.26605000000001], [59.812099999999994, 34.265950000000004], [59.8107, 34.265950000000004], [59.809999999999995, 34.26585], [59.8079, 34.26585], [59.807199999999995, 34.265750000000004], [59.805099999999996, 34.265750000000004], [59.804399999999994, 34.26565], [59.802299999999995, 34.26565], [59.80159999999999, 34.265550000000005], [59.7988, 34.265550000000005], [59.7981, 34.26545], [59.793899999999994, 34.26545], [59.7932, 34.265350000000005], [59.7827, 34.265350000000005], [59.782, 34.26525], [59.781299999999995, 34.265350000000005], [59.770799999999994, 34.265350000000005], [59.7701, 34.26545], [59.765899999999995, 34.26545], [59.76519999999999, 34.265550000000005], [59.7624, 34.265550000000005], [59.7617, 34.26565], [59.7596, 34.26565], [59.7589, 34.265750000000004], [59.7568, 34.265750000000004], [59.756099999999996, 34.26585], [59.754, 34.26585], [59.753299999999996, 34.265950000000004], [59.7519, 34.265950000000004], [59.7512, 34.26605000000001], [59.74979999999999, 34.26605000000001], [59.7491, 34.26615], [59.7484, 34.26615], [59.747699999999995, 34.26625000000001], [59.7463, 34.26625000000001], [59.745599999999996, 34.26635], [59.744899999999994, 34.26635], [59.7442, 34.266450000000006], [59.742799999999995, 34.266450000000006], [59.74209999999999, 34.26655], [59.7414, 34.26655], [59.7407, 34.266650000000006], [59.739999999999995, 34.266650000000006], [59.73929999999999, 34.26675], [59.7386, 34.26675], [59.737899999999996, 34.266850000000005], [59.737199999999994, 34.266850000000005], [59.7365, 34.26695], [59.7358, 34.26695], [59.734399999999994, 34.26715], [59.7309, 34.26715], [59.730199999999996, 34.267050000000005], [59.729499999999994, 34.267050000000005], [59.7281, 34.266850000000005], [59.727399999999996, 34.266850000000005], [59.726699999999994, 34.26675], [59.726, 34.26675], [59.724599999999995, 34.26655], [59.72389999999999, 34.26655], [59.7232, 34.266450000000006], [59.7225, 34.266450000000006], [59.721799999999995, 34.26635], [59.7211, 34.26635], [59.719699999999996, 34.26615], [59.718999999999994, 34.26615], [59.7183, 34.26605000000001], [59.7176, 34.26605000000001], [59.71619999999999, 34.26585], [59.7155, 34.26585], [59.7148, 34.265750000000004], [59.714099999999995, 34.265750000000004], [59.7127, 34.265550000000005], [59.711999999999996, 34.265550000000005], [59.711299999999994, 34.26545], [59.7106, 34.26545], [59.709199999999996, 34.26525], [59.708499999999994, 34.26525], [59.7078, 34.265150000000006], [59.7071, 34.265150000000006], [59.70569999999999, 34.264950000000006], [59.705, 34.264950000000006], [59.704299999999996, 34.26485], [59.703599999999994, 34.26485], [59.7022, 34.26465], [59.701499999999996, 34.26465], [59.700799999999994, 34.26455000000001], [59.7001, 34.26455000000001], [59.698699999999995, 34.26435], [59.69799999999999, 34.26435], [59.6973, 34.264250000000004], [59.6966, 34.264250000000004], [59.6952, 34.264050000000005], [59.6945, 34.264050000000005], [59.693799999999996, 34.26395], [59.693099999999994, 34.26395], [59.6924, 34.263850000000005], [59.6917, 34.26395], [59.69029999999999, 34.26375], [59.6875, 34.26415], [59.6868, 34.26415], [59.678399999999996, 34.265350000000005], [59.678399999999996, 34.26545], [59.6742, 34.26605000000001], [59.6742, 34.26615], [59.6714, 34.26655], [59.6714, 34.266650000000006], [59.6693, 34.26695], [59.6693, 34.267050000000005], [59.667199999999994, 34.26735], [59.667199999999994, 34.267450000000004], [59.6658, 34.26765], [59.6658, 34.26775000000001], [59.66439999999999, 34.267950000000006], [59.66439999999999, 34.26805], [59.663, 34.26825], [59.663, 34.268350000000005], [59.6616, 34.268550000000005], [59.6616, 34.26865], [59.6609, 34.268750000000004], [59.6609, 34.26885], [59.660199999999996, 34.268950000000004], [59.660199999999996, 34.26905], [59.6588, 34.26925000000001], [59.6588, 34.26935], [59.6581, 34.269450000000006], [59.6581, 34.26955], [59.657399999999996, 34.269650000000006], [59.657399999999996, 34.26975], [59.656699999999994, 34.269850000000005], [59.656699999999994, 34.26995], [59.656, 34.270050000000005], [59.656, 34.27015], [59.6553, 34.270250000000004], [59.6553, 34.27035], [59.654599999999995, 34.270450000000004], [59.654599999999995, 34.27055], [59.65389999999999, 34.27065], [59.65389999999999, 34.27085], [59.6532, 34.270950000000006], [59.6532, 34.27105], [59.652499999999996, 34.271150000000006], [59.652499999999996, 34.27125], [59.651799999999994, 34.271350000000005], [59.651799999999994, 34.271550000000005], [59.6511, 34.27165], [59.6511, 34.271750000000004], [59.6504, 34.27185], [59.6504, 34.27205], [59.649699999999996, 34.27215], [59.649699999999996, 34.27235], [59.648999999999994, 34.272450000000006], [59.648999999999994, 34.272650000000006], [59.6483, 34.27275], [59.6483, 34.27295], [59.6476, 34.273050000000005], [59.6476, 34.273250000000004], [59.646899999999995, 34.27335], [59.646899999999995, 34.27365], [59.64619999999999, 34.27375000000001], [59.64619999999999, 34.27405], [59.6455, 34.274150000000006], [59.6455, 34.27445], [59.6448, 34.274550000000005], [59.6448, 34.274950000000004], [59.644099999999995, 34.27505], [59.644099999999995, 34.275450000000006], [59.6434, 34.27555], [59.6434, 34.276050000000005], [59.6427, 34.27615], [59.6427, 34.276250000000005], [59.644099999999995, 34.276450000000004], [59.6448, 34.27635], [59.6483, 34.27635], [59.648999999999994, 34.276250000000005], [59.651799999999994, 34.276250000000005], [59.652499999999996, 34.27615], [59.656, 34.27615], [59.656699999999994, 34.276050000000005], [59.659499999999994, 34.276050000000005], [59.660199999999996, 34.27595], [59.6637, 34.27595], [59.66439999999999, 34.275850000000005], [59.667199999999994, 34.275850000000005], [59.667899999999996, 34.27575], [59.6714, 34.27575], [59.67209999999999, 34.275650000000006], [59.674899999999994, 34.275650000000006], [59.675599999999996, 34.27555], [59.6791, 34.27555], [59.67979999999999, 34.275450000000006], [59.682599999999994, 34.275450000000006], [59.683299999999996, 34.27535], [59.6868, 34.27535], [59.6875, 34.27525000000001], [59.6889, 34.27525000000001], [59.6896, 34.27535], [59.6896, 34.275650000000006], [59.6889, 34.27575], [59.6889, 34.276050000000005], [59.688199999999995, 34.27615], [59.688199999999995, 34.27655], [59.6875, 34.276650000000004], [59.6875, 34.27725], [59.6868, 34.277350000000006], [59.6868, 34.278850000000006], [59.686099999999996, 34.27895], [59.6868, 34.279050000000005], [59.6868, 34.280550000000005], [59.6875, 34.28065], [59.6875, 34.28125], [59.688199999999995, 34.28135], [59.688199999999995, 34.28175], [59.6889, 34.281850000000006], [59.6889, 34.28215], [59.6896, 34.282250000000005], [59.6896, 34.28255], [59.69029999999999, 34.282650000000004], [59.69029999999999, 34.28295000000001], [59.690999999999995, 34.28305], [59.690999999999995, 34.28325], [59.6917, 34.283350000000006], [59.6917, 34.283550000000005], [59.6924, 34.28365], [59.6924, 34.283750000000005], [59.693099999999994, 34.28385], [59.693099999999994, 34.28405], [59.693799999999996, 34.284150000000004], [59.693799999999996, 34.28425], [59.6945, 34.28435], [59.6945, 34.28455], [59.6952, 34.284650000000006], [59.6952, 34.28475], [59.695899999999995, 34.284850000000006], [59.695899999999995, 34.28495], [59.6966, 34.285050000000005], [59.6966, 34.28515], [59.6973, 34.285250000000005], [59.6973, 34.28535], [59.69799999999999, 34.285450000000004], [59.69799999999999, 34.28555], [59.6994, 34.28575], [59.6994, 34.28585], [59.7001, 34.28595000000001], [59.7001, 34.28605], [59.701499999999996, 34.28625], [59.701499999999996, 34.286350000000006], [59.7029, 34.286550000000005], [59.7029, 34.28665], [59.704299999999996, 34.28685], [59.704299999999996, 34.286950000000004], [59.706399999999995, 34.28725], [59.706399999999995, 34.28735], [59.708499999999994, 34.287650000000006], [59.708499999999994, 34.28775], [59.7204, 34.28945], [59.7211, 34.28945], [59.7232, 34.289750000000005], [59.72389999999999, 34.289750000000005], [59.726, 34.29005], [59.726699999999994, 34.29005], [59.7281, 34.29025], [59.7288, 34.29025], [59.730199999999996, 34.29045000000001], [59.7309, 34.29045000000001], [59.732299999999995, 34.29065000000001], [59.733, 34.29065000000001], [59.7337, 34.29075], [59.734399999999994, 34.29075], [59.7358, 34.29095], [59.7365, 34.29095], [59.737199999999994, 34.291050000000006], [59.737899999999996, 34.291050000000006], [59.7386, 34.29115], [59.73929999999999, 34.29115], [59.739999999999995, 34.291250000000005], [59.7407, 34.291250000000005], [59.7414, 34.29135], [59.74209999999999, 34.29135], [59.742799999999995, 34.291450000000005], [59.7442, 34.291450000000005], [59.744899999999994, 34.29155], [59.745599999999996, 34.29155], [59.7463, 34.291650000000004], [59.747699999999995, 34.291650000000004], [59.7484, 34.29175], [59.7491, 34.29175], [59.74979999999999, 34.291850000000004], [59.7512, 34.291850000000004], [59.7519, 34.29195], [59.753299999999996, 34.29195], [59.754, 34.29205], [59.756099999999996, 34.29205], [59.7568, 34.29215000000001], [59.7589, 34.29215000000001], [59.7596, 34.29225], [59.7617, 34.29225], [59.7624, 34.292350000000006], [59.76519999999999, 34.292350000000006], [59.765899999999995, 34.29245], [59.7701, 34.29245], [59.770799999999994, 34.292550000000006], [59.781299999999995, 34.292550000000006], [59.782, 34.29265], [59.7827, 34.292550000000006], [59.784099999999995, 34.292550000000006], [59.7848, 34.29265], [59.7848, 34.292750000000005], [59.784099999999995, 34.29285], [59.784099999999995, 34.29305], [59.78339999999999, 34.293150000000004], [59.78339999999999, 34.293350000000004], [59.7827, 34.29345], [59.7827, 34.29365000000001], [59.782, 34.29375], [59.782, 34.29395], [59.781299999999995, 34.294050000000006], [59.781299999999995, 34.29415], [59.7806, 34.294250000000005], [59.7806, 34.294450000000005], [59.7799, 34.29455], [59.7799, 34.29475], [59.779199999999996, 34.294850000000004], [59.779199999999996, 34.29505], [59.778499999999994, 34.29515000000001], [59.778499999999994, 34.29525], [59.7778, 34.295350000000006], [59.7778, 34.295550000000006], [59.7771, 34.29565], [59.7771, 34.29585], [59.776399999999995, 34.295950000000005], [59.776399999999995, 34.296150000000004], [59.77569999999999, 34.29625], [59.77569999999999, 34.29645], [59.775, 34.29655], [59.775, 34.29665000000001], [59.7743, 34.29675], [59.7743, 34.29695], [59.773599999999995, 34.297050000000006], [59.773599999999995, 34.297250000000005], [59.7729, 34.29735], [59.7729, 34.29755], [59.7722, 34.297650000000004], [59.7722, 34.297850000000004], [59.771499999999996, 34.29795], [59.771499999999996, 34.29805], [59.770799999999994, 34.29815000000001], [59.770799999999994, 34.298350000000006], [59.7701, 34.29845], [59.7701, 34.298750000000005], [59.770799999999994, 34.29885], [59.7701, 34.298950000000005], [59.781299999999995, 34.298950000000005], [59.782, 34.29905], [59.7827, 34.298950000000005], [59.796, 34.298950000000005], [59.796699999999994, 34.29885], [59.80159999999999, 34.29885], [59.802299999999995, 34.298750000000005], [59.8058, 34.298750000000005], [59.8065, 34.29865], [59.80929999999999, 34.29865], [59.809999999999995, 34.298550000000006], [59.80929999999999, 34.29845], [59.80929999999999, 34.298350000000006], [59.8086, 34.29825], [59.8086, 34.29815000000001], [59.8079, 34.29805], [59.8079, 34.297850000000004], [59.807199999999995, 34.29775], [59.807199999999995, 34.297650000000004], [59.8065, 34.29755], [59.8065, 34.297250000000005], [59.8058, 34.29715], [59.8058, 34.296850000000006], [59.805099999999996, 34.29675], [59.805099999999996, 34.295950000000005], [59.804399999999994, 34.29585], [59.804399999999994, 34.29495], [59.805099999999996, 34.294850000000004], [59.805099999999996, 34.294050000000006], [59.8058, 34.29395], [59.8058, 34.29365000000001], [59.8065, 34.29355], [59.8065, 34.29325], [59.807199999999995, 34.293150000000004], [59.807199999999995, 34.29305], [59.8079, 34.292950000000005], [59.8079, 34.292750000000005], [59.8086, 34.29265], [59.8086, 34.292550000000006], [59.80929999999999, 34.29245], [59.80929999999999, 34.292350000000006], [59.809999999999995, 34.29225], [59.809999999999995, 34.29215000000001], [59.8107, 34.29205], [59.8107, 34.29195], [59.812099999999994, 34.29175], [59.812099999999994, 34.291650000000004], [59.8142, 34.29135], [59.8142, 34.291250000000005], [59.8212, 34.29025], [59.8219, 34.29025], [59.824, 34.289950000000005], [59.8247, 34.289950000000005], [59.8261, 34.289750000000005], [59.8268, 34.289750000000005], [59.82749999999999, 34.28965], [59.828199999999995, 34.28965], [59.8289, 34.289550000000006], [59.8296, 34.289550000000006], [59.830299999999994, 34.28945], [59.830999999999996, 34.28945], [59.830999999999996, 34.28875], [59.8317, 34.288650000000004], [59.8317, 34.288250000000005], [59.8324, 34.28815], [59.8324, 34.28775], [59.833099999999995, 34.287650000000006], [59.833099999999995, 34.28735], [59.8338, 34.28725], [59.8338, 34.286950000000004], [59.8345, 34.28685], [59.8345, 34.28665], [59.83519999999999, 34.286550000000005], [59.83519999999999, 34.28645], [59.835899999999995, 34.286350000000006], [59.835899999999995, 34.286150000000006], [59.8366, 34.28605], [59.8366, 34.28595000000001], [59.8373, 34.28585], [59.8373, 34.28575], [59.837999999999994, 34.285650000000004], [59.837999999999994, 34.28555], [59.838699999999996, 34.285450000000004], [59.838699999999996, 34.28535], [59.8394, 34.285250000000005], [59.8394, 34.28515], [59.8401, 34.285050000000005], [59.8401, 34.28495], [59.8422, 34.284650000000006], [59.8422, 34.28455], [59.849199999999996, 34.283550000000005], [59.8499, 34.283550000000005], [59.851299999999995, 34.283350000000006], [59.852, 34.283350000000006], [59.8527, 34.28325], [59.85339999999999, 34.28325], [59.854099999999995, 34.283150000000006], [59.8555, 34.283150000000006], [59.856199999999994, 34.28305], [59.858999999999995, 34.28305], [59.8597, 34.28295000000001], [59.864599999999996, 34.28295000000001], [59.8653, 34.28305], [59.8681, 34.28305], [59.86879999999999, 34.283150000000006], [59.869499999999995, 34.283150000000006], [59.8702, 34.28325], [59.871599999999994, 34.28325], [59.872299999999996, 34.283350000000006], [59.873, 34.283350000000006], [59.874399999999994, 34.283550000000005], [59.875099999999996, 34.283550000000005], [59.882099999999994, 34.28455], [59.882099999999994, 34.284650000000006], [59.8835, 34.284850000000006], [59.8835, 34.28495], [59.884899999999995, 34.28515], [59.884899999999995, 34.285250000000005], [59.8856, 34.28535], [59.8856, 34.285450000000004], [59.8863, 34.28555], [59.8863, 34.285650000000004], [59.88699999999999, 34.28575], [59.88699999999999, 34.28585], [59.887699999999995, 34.28595000000001], [59.887699999999995, 34.28605], [59.8884, 34.286150000000006], [59.8884, 34.286350000000006], [59.8891, 34.28645], [59.8891, 34.28665], [59.889799999999994, 34.286750000000005], [59.889799999999994, 34.286950000000004], [59.890499999999996, 34.28705], [59.890499999999996, 34.28725], [59.8912, 34.28735], [59.8912, 34.287650000000006], [59.8919, 34.28775], [59.8919, 34.28815], [59.892599999999995, 34.288250000000005], [59.892599999999995, 34.288850000000004], [59.893299999999996, 34.28895000000001], [59.893299999999996, 34.29115], [59.89469999999999, 34.29095], [59.89469999999999, 34.290850000000006], [59.8968, 34.29055], [59.8968, 34.29045000000001], [59.898199999999996, 34.29025], [59.898199999999996, 34.290150000000004], [59.8996, 34.289950000000005], [59.8996, 34.28985], [59.900999999999996, 34.28965], [59.900999999999996, 34.289550000000006], [59.90239999999999, 34.289350000000006], [59.90239999999999, 34.28925], [59.903099999999995, 34.28915000000001], [59.903099999999995, 34.28905], [59.9038, 34.28895000000001], [59.9038, 34.288850000000004], [59.905199999999994, 34.288650000000004], [59.905199999999994, 34.28855], [59.905899999999995, 34.288450000000005], [59.905899999999995, 34.28835], [59.9066, 34.288250000000005], [59.9066, 34.28815], [59.9073, 34.288050000000005], [59.9073, 34.28795], [59.907999999999994, 34.287850000000006], [59.907999999999994, 34.28775], [59.908699999999996, 34.287650000000006], [59.908699999999996, 34.28755], [59.9094, 34.28745000000001], [59.9094, 34.28735], [59.9101, 34.28725], [59.9101, 34.28705], [59.910799999999995, 34.286950000000004], [59.910799999999995, 34.28685], [59.9115, 34.286750000000005], [59.9115, 34.28665], [59.9122, 34.286550000000005], [59.9122, 34.286350000000006], [59.91289999999999, 34.28625], [59.91289999999999, 34.286150000000006], [59.913599999999995, 34.28605], [59.913599999999995, 34.28585], [59.9143, 34.28575], [59.9143, 34.28555], [59.915, 34.285450000000004], [59.915, 34.285250000000005], [59.915699999999994, 34.28515], [59.915699999999994, 34.28495], [59.916399999999996, 34.284850000000006], [59.916399999999996, 34.284650000000006], [59.9171, 34.28455], [59.9171, 34.28425], [59.9178, 34.284150000000004], [59.9178, 34.28385], [59.918499999999995, 34.283750000000005], [59.918499999999995, 34.28345], [59.9192, 34.283350000000006], [59.9192, 34.28295000000001], [59.9199, 34.28285], [59.9199, 34.282450000000004], [59.92059999999999, 34.28235], [59.92059999999999, 34.281850000000006], [59.921299999999995, 34.28175], [59.921299999999995, 34.28105], [59.922, 34.280950000000004], [59.922, 34.279050000000005]]; -->
                            var maskCoords = response.test_data;
                            console.log(maskCoords)

                            // Отображение маски (полигона) на карте
                            var polygon = L.polygon(maskCoords, {
                                color: 'blue',
                                fillColor: '#add8e6',
                                fillOpacity: 0.5
                            }).addTo(map);

                            polygon.bindTooltip("Маска", {
                                permanent: false,
                                direction: 'top'
                            });

                            map.eachLayer(function (layer) {
                                if (layer instanceof L.Marker || layer instanceof L.Circle) {
                                    map.removeLayer(layer);
                                }
                            });
                            
                            // Добавляем метку для центра ПСР
                            L.marker([response.coords_psr.latitude, response.coords_psr.longitude]).addTo(map)
                                .bindTooltip('Центр ПСР')
                                .openTooltip();
                            
                            var circles = [];
                            // Добавляем круговой радиус
                            // Создаем круг
                            var radiusInMeters = response.radius * 1000; // если радиус в километрах
                            var circle = L.circle([response.coords_psr.latitude, response.coords_psr.longitude], {
                                color: 'blue',
                                fillColor: '#add8e6',
                                fillOpacity: 0.5,
                                radius: radiusInMeters
                            }).addTo(map);

                            //test!!!!
                            var radiusIn = 5 * 1000; // если радиус в километрах
                            var circle = L.circle([response.coords_psr.latitude, response.coords_psr.longitude], {
                                color: 'red',
                                // fillColor: '#add8e6',
                                fillOpacity: 0.5,
                                radius: radiusIn
                            }).addTo(map);

                            // Добавляем всплывающую подсказку на круг
                            circle.bindTooltip("Общий радиус: " + response.radius + " км", {
                                permanent: false, // подсказка будет отображаться только при наведении
                                direction: 'top', // направление текста (вверх)
                                className: 'circle-tooltip' // класс для стилизации, если нужно
                            });
                            circles.push(circle);


                            for (var i = response.prev_radius.length - 1; i >= 0; i--) {
                                var radius = response.prev_radius[i];
                                var radiusInMeters = radius * 1000; // если радиус в километрах

                                // Создаем круг
                                var circle = L.circle([response.coords_psr.latitude, response.coords_psr.longitude], {
                                    color: 'blue',
                                    fillColor: '#add8e6',
                                    fillOpacity: 0,
                                    radius: radiusInMeters
                                }).addTo(map);

                                // Добавляем всплывающую подсказку на круг
                                circle.bindTooltip("День " + parseInt(i+1, 10) + " радиус: " + radius + " км", {
                                    permanent: false,
                                    direction: 'top',
                                    className: 'circle-tooltip'
                                });
                                circles.push(circle);

                                // Добавляем события для изменения прозрачности при наведении и уходе
                                // circle.on('mouseover', function() {
                                //     // сircle.setStyle({ fillOpacity: 0.5 });
                                //     circles.forEach(function(c) {
                                //         if (c !== this) {
                                //             c.setStyle({ opacity: 0 });
                                //             c.setStyle({ fillOpacity: 0 }); // Делаем остальные круги прозрачными
                                //         }
                                //     }, this);
                                // });

                                // circle.on('mouseout', function() {
                                //     сircles[0].setStyle({ fillOpacity: 0.5 });

                                //     circles.forEach(function(c) {
                                //         c.setStyle({ opacity: 0.5 }); // Возвращаем исходную прозрачность
                                //     });
                                // });

                            }

                            
                            // Добавляем метку для координат нахождения
                            if (response.coords_finding) {
                                L.marker([response.coords_finding.latitude, response.coords_finding.longitude]).addTo(map)
                                    .bindTooltip('Место нахождения')
                                    .openTooltip();
                            } else {
                                alert('Не удалось получить координаты нахождения.');
                            }
                            document.getElementById('result').classList.add('alert', 'alert-info')
                            document.getElementById('result').innerHTML = response.behavior.replace(/%/g, '%  <br>');

                            $('#loader').hide(); // Скрыть индикатор загрузки после получения ответа
                            $('#overlay').hide(); // Скрыть полупрозрачный фон
                            // document.getElementById('extra_result').innerHTML = response.extra_info.replace(/  /g, ' <br>');
                            function generateReportFromText(text) {
                                const container = document.getElementById('report');
                                container.innerHTML = ''; // Очистка контейнера перед добавлением нового содержимого

                                // Разделение текста по дням
                                const days = text.split(/(?=День \d+:)/g);
                                // Получение значений времени из элементов
                                const timeOfLossInput = document.getElementById('time_of_loss');
                                const time_of_loss_1 = timeOfLossInput.value;

                                const timeOfFindingInput = document.getElementById('time_of_finding');
                                const time_of_finding_1 = timeOfFindingInput.value;
                                days.forEach((day, dayIndex) => {
                                // Определение номера дня
                                const dayMatch = day.match(/День (\d+):/);
                                if (dayMatch) {
                                    const dayNumber = dayMatch[1];
                                    const dayDiv = document.createElement('div');
                                    dayDiv.className = 'day';
                                    dayDiv.innerHTML = `<strong>День ${dayNumber}:</strong>`;

                                    // Извлечение активностей с помощью точного регулярного выражения
                                    const activities = day.replace(/День \d+: /, '').trim().match(/\d+\.\d+ [^:]+: \d+\.\d+% [^ ]+ (morning|day|evening|night)/g);

                                    if (activities) {
                                        activities.forEach((activity, activityIndex) => {
                                            if (activity.trim() !== '') {
                                                // Извлечение статуса активности (good, bad, neutral)
                                                const statusMatch = activity.match(/(\bgood\b|\bbad\b)/);
                                                const status = statusMatch ? statusMatch[0] : 'neutral';

                                                // Извлечение части дня (morning, day, evening, night)
                                                const timeOfDayMatch = activity.match(/\b(morning|day|evening|night)\b/);
                                                const timeOfDay = timeOfDayMatch ? timeOfDayMatch[0] : 'day';

                                                // Определение временного диапазона для каждой части дня
                                                let timeRange;
                                                if (dayIndex === 0 && activityIndex === 0) {
                                                    // Если это первый день и первая активность
                                                    switch (timeOfDay) {
                                                        case 'morning':
                                                            timeRange = `с ${time_of_loss_1} до 11:59`;
                                                            break;
                                                        case 'day':
                                                            timeRange = `с ${time_of_loss_1} до 17:59`;
                                                            break;
                                                        case 'evening':
                                                            timeRange = `с ${time_of_loss_1} до 23:59`;
                                                            break;
                                                        case 'night':
                                                            timeRange = `с ${time_of_loss_1} до 05:59`;
                                                            break;
                                                    }
                                                } else if (dayIndex === days.length - 1 && activityIndex === activities.length - 1) {
                                                    // Если это последний день и последняя активность
                                                    switch (timeOfDay) {
                                                        case 'morning':
                                                            timeRange = `с 06:00 до ${time_of_finding_1}`;
                                                            break;
                                                        case 'day':
                                                            timeRange = `с 12:00 до ${time_of_finding_1}`;
                                                            break;
                                                        case 'evening':
                                                            timeRange = `с 18:00 до ${time_of_finding_1}`;
                                                            break;
                                                        case 'night':
                                                            timeRange = `с 00:00 до ${time_of_finding_1}`;
                                                            break;
                                                    }
                                                } else {
                                                    // Обычные временные интервалы для остальных случаев
                                                    switch (timeOfDay) {
                                                        case 'morning':
                                                            timeRange = 'с 06:00 до 11:59';
                                                            break;
                                                        case 'day':
                                                            timeRange = 'с 12:00 до 17:59';
                                                            break;
                                                        case 'evening':
                                                            timeRange = 'с 18:00 до 23:59';
                                                            break;
                                                        case 'night':
                                                            timeRange = 'с 00:00 до 05:59';
                                                            break;
                                                    }
                                                }
                                                // switch (timeOfDay) {
                                                //     case 'morning':
                                                //         if (dayIndex === 0 && activityIndex === 0) {
                                                //             timeRange = `с ${time_of_loss_1} до 11:59`;
            
                                                //         }
                                                //         if (dayIndex === days.length - 1 && activityIndex === activities.length - 1) {
                                                //         timeRange = `с 06:00 до ${time_of_finding_1}`;
                                                //         }
                                                //         else
                                                //             timeRange = 'с 06:00 до 11:59'; // Утро
                                                //         break;
                                                //     case 'day':
                                                //         if (dayIndex === 0 && activityIndex === 0) {
                                                //             timeRange = `с ${time_of_loss_1} до 17:59`;
                                                //         }
                                                //         if (dayIndex === days.length - 1 && activityIndex === activities.length - 1) {
                                                //         timeRange = `с 12:00 до ${time_of_finding_1}`;
                                                //         }
                                                //         else
                                                //             timeRange = 'с 12:00 до 17:59'; // День
                                                //         break;
                                                //     case 'evening':
                                                //         if (dayIndex === 0 && activityIndex === 0) {
                                                //             timeRange = `с ${time_of_loss_1} до 23:59`;
                                                //             }
                                                //         if (dayIndex === days.length - 1 && activityIndex === activities.length - 1) {
                                                //             timeRange = `с 18:00 до ${time_of_finding_1}`;
                                                //         }
                                                //         else
                                                //             timeRange = 'с 18:00 до 23:59'; // Вечер
                                                //             break;
                                                //     case 'night':
                                                //         if (dayIndex === 0 && activityIndex === 0) {
                                                //             timeRange = `с ${time_of_loss_1} до 05:59`;
                                                //             }
                                                //         if (dayIndex === days.length - 1 && activityIndex === activities.length - 1) {
                                                //         timeRange = `с 00:00 до ${time_of_finding_1}`;
                                                //         }
                                                //         else
                                                //             timeRange = 'с 00:00 до 05:59'; // Ночь
                                                //         break;
                                                // }
                                                // Формирование строки активности с временным диапазоном
                                                const activityHtml = `<div class="activity ${status}">${timeRange}: ${activity.trim()}</div>`;
                                                dayDiv.innerHTML += activityHtml; // Добавление активности без разрыва строки
                                            }
                                        });
                                    }

                                    container.appendChild(dayDiv);
                                }
                            });

                            }
                            generateReportFromText(response.extra_info.replace(/  /g, ' <br>'));
                            console.log(response.extra_info);
                            
                        } else {
                            $('#overlay').hide(); // Скрыть полупрозрачный фон
                            $('#loader').hide(); // Скрыть индикатор загрузки, если нет координат
                            alert('Не удалось получить координаты.');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', status, error);
                        $('#overlay').hide(); // Скрыть полупрозрачный фон
                        $('#loader').hide(); // Скрыть индикатор загрузки в случае ошибки
                        alert('Ошибка при отправке данных.');
                    }
                });
            });
        });
    </script>
</body>
</html>
